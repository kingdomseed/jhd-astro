---
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import HeadFonts from "../../../components/HeadFonts.astro";
import PageHeader from "../../../components/PageHeader.astro";
import { Image } from "astro:assets";
import { formatDate } from "../../../scripts/format-date";
import defaultOg from "../../../assets/logo/logo.jpg?url"; // Default site OG image
import { getEntry, getCollection, type CollectionEntry } from "astro:content";
import ShareBar from "../../../components/ShareBar.astro";

type ResourceEntry = CollectionEntry<"resources">;
// Narrow the type of individual steps for stronger typing in map callback
type ResourceStep = ResourceEntry["data"]["steps"][number];

export async function getStaticPaths() {
    const entries = await getCollection("resources", ({ data }) => {
        return data.lang === "pt";
    });
    return entries.map((entry: ResourceEntry) => ({
        params: { slug: entry.slug },
    }));
}

const { slug } = Astro.params;

if (!slug || Array.isArray(slug)) {
    throw new Error("Invalid resource slug");
}

const entry = await getEntry("resources", slug);

if (!entry) {
    throw new Error(`Resource not found for slug: ${slug}`);
}

const { Content } = await entry.render();
const resource = entry.data;

// Build Related Guides list
const allResources = await getCollection("resources", ({ data }) => {
    return data.lang === "pt";
});
// Helper: resolve a slug to entry safely
const resolveResource = (s: string) => allResources.find((e) => e.slug === s);
const explicitRelated = Array.isArray(resource.related)
    ? resource.related
          .map((s: string) => resolveResource(s))
          .filter((e): e is ResourceEntry => {
              if (!e) return false;
              return e.slug !== entry.slug;
          })
    : [];
// Fallback suggestions (same category, then tag overlap), excluding duplicates/self
const seen = new Set<string>([
    entry.slug,
    ...explicitRelated.map((e) => e.slug),
]);
const sameCategory = allResources
    .filter((e) => e.data.category === resource.category && !seen.has(e.slug))
    .sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0));
sameCategory.slice(0, 3).forEach((e) => seen.add(e.slug));
const tags = new Set<string>(Array.isArray(resource.tags) ? resource.tags : []);
const tagOverlap = allResources
    .filter((e) => !seen.has(e.slug))
    .map((e) => ({
        entry: e,
        score: (e.data.tags || []).reduce(
            (acc: number, t: string) => acc + (tags.has(t) ? 1 : 0),
            0,
        ),
    }))
    .filter((x) => x.score > 0)
    .sort((a, b) => b.score - a.score)
    .map((x) => x.entry);
const fallbackRelated = [...sameCategory, ...tagOverlap].slice(
    0,
    Math.max(0, 3 - explicitRelated.length),
);
const relatedEntries: ResourceEntry[] = [
    ...explicitRelated,
    ...fallbackRelated,
];
// Group downloads (if any) into Schemas, Examples, Templates based on label keywords
const downloads = Array.isArray(resource.downloads) ? resource.downloads : [];
const dlSchemas = downloads.filter((d) => /schema/i.test(d.label));
const dlExamples = downloads.filter((d) => /(example|sample)/i.test(d.label));
const dlTemplates = downloads.filter((d) => /template/i.test(d.label));
const dlOther = downloads.filter(
    (d) => !/(schema|example|sample|template)/i.test(d.label),
);

const categoryLabels = {
    "start-here": "Comece Aqui",
    "adventure-journals": "Diários de Aventura",
    "dice-roller": "Rolador de Dados",
    "custom-tables": "Tabelas Personalizadas",
    advanced: "Esquemas e Aprofundamentos",
};

const sectionAnchors = {
    "start-here": "#start-here",
    "adventure-journals": "#adventure-journals",
    "dice-roller": "#dice-roller",
    "custom-tables": "#custom-tables",
    advanced: "#schemas",
};

const parentAnchor = sectionAnchors[resource.category] ?? "";
const backHref = `/pt/resources${parentAnchor}`;
const canonicalUrl = `https://jasonholtdigital.com/pt/resources/${entry.slug}/`;
// Compute absolute OG image URL using resource hero or default site image
const ogSrcPath = resource.hero?.src ?? defaultOg;
const ogImageUrl = new URL(
    ogSrcPath,
    Astro.site ?? "https://jasonholtdigital.com",
).toString();
const ogImageAlt = resource.heroAlt ?? resource.title;
---

<html lang="pt">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <HeadFonts />
        <title>{resource.title} — Mythic Resources</title>
        <meta name="description" content={resource.summary} />
        <link rel="canonical" href={canonicalUrl} />
        <link rel="stylesheet" href="/global.css" />
        <script
            is:inline
            src="https://kit.fontawesome.com/9f0db3cdf4.js"
            crossorigin="anonymous"></script>
        <meta property="og:image" content={ogImageUrl} />
        {ogImageAlt && <meta property="og:image:alt" content={ogImageAlt} />}
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:image" content={ogImageUrl} />
    </head>
    <body>
        <a class="skip" href="#main">Pular para o conteúdo principal</a>
        <div id="bg-atmo" aria-hidden="true"></div>
        <div id="site">
            <Header />

            <PageHeader
                title={resource.title}
                subtitle={categoryLabels[resource.category]}
                description={resource.summary}
                accent="Recursos"
                layout="left"
                icon="fa-solid fa-book-open"
                visualElement="grid"
                colorScheme="primary"
            />

            <main id="main" class="resource-detail-main">
                <article
                    class="container section resource-detail"
                    aria-labelledby="resource-detail-heading"
                >
                    <div class="resource-detail__inner">
                        <p class="resource-detail__back">
                            <a class="resource-back-link" href={backHref}>
                                <i
                                    class="fa-slab fa-regular fa-arrow-left"
                                    aria-hidden="true"></i>
                                Voltar para recursos
                            </a>
                        </p>
                        <header class="resource-detail__header">
                            <h2
                                id="resource-detail-heading"
                                class="resource-detail__title"
                            >
                                {resource.title}
                            </h2>
                            <div
                                class="resource-detail__meta"
                                aria-label="Metadados do recurso"
                            >
                                <span class="resource-pill"
                                    >{categoryLabels[resource.category]}</span
                                >
                                {
                                    resource.duration && (
                                        <span class="resource-pill">
                                            {resource.duration}
                                        </span>
                                    )
                                }
                                {
                                    resource.updated && (
                                        <span class="resource-pill">
                                            Atualizado em{" "}
                                            {formatDate(resource.updated)}
                                        </span>
                                    )
                                }
                            </div>
                            {
                                resource.externalUrl && (
                                    <p class="resource-detail__download">
                                        <a
                                            class="btn btn--shadow-accent"
                                            href={resource.externalUrl}
                                            target="_blank"
                                            rel="noopener"
                                        >
                                            <i
                                                class="fa-slab fa-regular fa-arrow-down-to-line"
                                                aria-hidden="true"
                                            />
                                            Abrir esquema / download
                                        </a>
                                    </p>
                                )
                            }
                        </header>
                        <ShareBar
                            url={canonicalUrl}
                            title={resource.title}
                            summary={resource.summary}
                        />
                        {
                            /** Optional hero image at the top of the guide. Alt text is enforced by schema when hero is present. */
                        }
                        {
                            resource.hero && (
                                <figure class="resource-hero">
                                    <Image
                                        src={resource.hero}
                                        alt={resource.heroAlt ?? ""}
                                        widths={[480, 768, 1024, 1440]}
                                        sizes="(max-width: 768px) 92vw, 1100px"
                                        loading="eager"
                                        decoding="async"
                                        fetchpriority="high"
                                        class="resource-hero__img"
                                    />
                                    {resource.heroAlt && (
                                        <figcaption class="resource-hero__caption">
                                            {resource.heroAlt}
                                        </figcaption>
                                    )}
                                </figure>
                            )
                        }
                        <div class="resource-detail__content">
                            <Content />
                        </div>
                        {
                            relatedEntries.length > 0 && (
                                <section
                                    class="section"
                                    aria-labelledby="resource-related-title"
                                >
                                    <header
                                        class="section-head"
                                        aria-hidden="true"
                                    >
                                        <span
                                            class="accent-line"
                                            aria-hidden="true"
                                        />
                                        <span class="badge-text">
                                            Relacionado
                                        </span>
                                    </header>
                                    <h3
                                        id="resource-related-title"
                                        class="section-title"
                                    >
                                        Guias Relacionados
                                    </h3>
                                    <ul
                                        class="resource-related__list"
                                        aria-label="Guias relacionados"
                                    >
                                        {relatedEntries.map((r) => (
                                            <li class="resource-related__item">
                                                <a
                                                    href={`/pt/resources/${r.slug}/`}
                                                    class="resource-related__link"
                                                >
                                                    <span
                                                        class="resource-related__icon"
                                                        aria-hidden="true"
                                                    >
                                                        <i
                                                            class={
                                                                r.data.icon ??
                                                                "fa-slab fa-regular fa-book-open"
                                                            }
                                                        />
                                                    </span>
                                                    <span class="resource-related__body">
                                                        <span class="resource-related__label">
                                                            {r.data.title}
                                                        </span>
                                                        <span class="resource-related__summary">
                                                            {r.data.summary}
                                                        </span>
                                                    </span>
                                                    <span
                                                        class="resource-related__arrow"
                                                        aria-hidden="true"
                                                    >
                                                        <i class="fa-slab fa-regular fa-arrow-right" />
                                                    </span>
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </section>
                            )
                        }
                        {
                            downloads.length > 0 && (
                                <section
                                    class="section section-band"
                                    aria-labelledby="resource-downloads-title"
                                >
                                    <header
                                        class="section-head"
                                        aria-hidden="true"
                                    >
                                        <span
                                            class="accent-line"
                                            aria-hidden="true"
                                        />
                                        <span class="badge-text">
                                            Downloads
                                        </span>
                                    </header>
                                    <h3
                                        id="resource-downloads-title"
                                        class="section-title"
                                    >
                                        Downloads
                                    </h3>
                                    <div class="resource-downloads__groups">
                                        {dlSchemas.length > 0 && (
                                            <div class="resource-downloads__group">
                                                <h4 class="resource-downloads__group-title">
                                                    Schemas
                                                </h4>
                                                <ul
                                                    class="resource-downloads__list"
                                                    aria-label="Schema downloads"
                                                >
                                                    {dlSchemas.map((d) => (
                                                        <li class="resource-downloads__item">
                                                            <a
                                                                href={d.href}
                                                                class="resource-downloads__link"
                                                                download
                                                            >
                                                                <span
                                                                    class="resource-downloads__icon"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-down-to-line" />
                                                                </span>
                                                                <span class="resource-downloads__body">
                                                                    <span class="resource-downloads__label">
                                                                        {
                                                                            d.label
                                                                        }
                                                                    </span>
                                                                    <span class="resource-downloads__meta">
                                                                        {d.format && (
                                                                            <span class="resource-downloads__format">
                                                                                {
                                                                                    d.format
                                                                                }
                                                                            </span>
                                                                        )}
                                                                        {d.size && (
                                                                            <span class="resource-downloads__size">
                                                                                {
                                                                                    d.size
                                                                                }
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                </span>
                                                                <span
                                                                    class="resource-downloads__arrow"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-right" />
                                                                </span>
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {dlExamples.length > 0 && (
                                            <div class="resource-downloads__group">
                                                <h4 class="resource-downloads__group-title">
                                                    Exemplos
                                                </h4>
                                                <ul
                                                    class="resource-downloads__list"
                                                    aria-label="Example downloads"
                                                >
                                                    {dlExamples.map((d) => (
                                                        <li class="resource-downloads__item">
                                                            <a
                                                                href={d.href}
                                                                class="resource-downloads__link"
                                                                download
                                                            >
                                                                <span
                                                                    class="resource-downloads__icon"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-down-to-line" />
                                                                </span>
                                                                <span class="resource-downloads__body">
                                                                    <span class="resource-downloads__label">
                                                                        {
                                                                            d.label
                                                                        }
                                                                    </span>
                                                                    <span class="resource-downloads__meta">
                                                                        {d.format && (
                                                                            <span class="resource-downloads__format">
                                                                                {
                                                                                    d.format
                                                                                }
                                                                            </span>
                                                                        )}
                                                                        {d.size && (
                                                                            <span class="resource-downloads__size">
                                                                                {
                                                                                    d.size
                                                                                }
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                </span>
                                                                <span
                                                                    class="resource-downloads__arrow"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-right" />
                                                                </span>
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {dlTemplates.length > 0 && (
                                            <div class="resource-downloads__group">
                                                <h4 class="resource-downloads__group-title">
                                                    Modelos
                                                </h4>
                                                <ul
                                                    class="resource-downloads__list"
                                                    aria-label="Template downloads"
                                                >
                                                    {dlTemplates.map((d) => (
                                                        <li class="resource-downloads__item">
                                                            <a
                                                                href={d.href}
                                                                class="resource-downloads__link"
                                                                download
                                                            >
                                                                <span
                                                                    class="resource-downloads__icon"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-down-to-line" />
                                                                </span>
                                                                <span class="resource-downloads__body">
                                                                    <span class="resource-downloads__label">
                                                                        {
                                                                            d.label
                                                                        }
                                                                    </span>
                                                                    <span class="resource-downloads__meta">
                                                                        {d.format && (
                                                                            <span class="resource-downloads__format">
                                                                                {
                                                                                    d.format
                                                                                }
                                                                            </span>
                                                                        )}
                                                                        {d.size && (
                                                                            <span class="resource-downloads__size">
                                                                                {
                                                                                    d.size
                                                                                }
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                </span>
                                                                <span
                                                                    class="resource-downloads__arrow"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-right" />
                                                                </span>
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                        {dlOther.length > 0 && (
                                            <div class="resource-downloads__group">
                                                <h4 class="resource-downloads__group-title">
                                                    Outros
                                                </h4>
                                                <ul
                                                    class="resource-downloads__list"
                                                    aria-label="Other downloads"
                                                >
                                                    {dlOther.map((d) => (
                                                        <li class="resource-downloads__item">
                                                            <a
                                                                href={d.href}
                                                                class="resource-downloads__link"
                                                                download
                                                            >
                                                                <span
                                                                    class="resource-downloads__icon"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-down-to-line" />
                                                                </span>
                                                                <span class="resource-downloads__body">
                                                                    <span class="resource-downloads__label">
                                                                        {
                                                                            d.label
                                                                        }
                                                                    </span>
                                                                    <span class="resource-downloads__meta">
                                                                        {d.format && (
                                                                            <span class="resource-downloads__format">
                                                                                {
                                                                                    d.format
                                                                                }
                                                                            </span>
                                                                        )}
                                                                        {d.size && (
                                                                            <span class="resource-downloads__size">
                                                                                {
                                                                                    d.size
                                                                                }
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                </span>
                                                                <span
                                                                    class="resource-downloads__arrow"
                                                                    aria-hidden="true"
                                                                >
                                                                    <i class="fa-slab fa-regular fa-arrow-right" />
                                                                </span>
                                                            </a>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                </section>
                            )
                        }
                        {
                            Array.isArray(resource.steps) &&
                                resource.steps.length > 0 && (
                                    // Structured steps: present a scannable, accessible sequence
                                    <section
                                        class="section"
                                        aria-labelledby="resource-steps-title"
                                    >
                                        <header
                                            class="section-head"
                                            aria-hidden="true"
                                        >
                                            <span
                                                class="accent-line"
                                                aria-hidden="true"
                                            />
                                            <span class="badge-text">
                                                Passos
                                            </span>
                                        </header>
                                        <h3
                                            id="resource-steps-title"
                                            class="section-title"
                                        >
                                            Passo a passo
                                        </h3>
                                        <ol class="resource-steps">
                                            {resource.steps.map(
                                                (
                                                    s: ResourceStep,
                                                    i: number,
                                                ) => (
                                                    <li
                                                        class="resource-step"
                                                        data-step-index={i + 1}
                                                    >
                                                        <h4 class="resource-step__title">
                                                            {s.title}
                                                        </h4>
                                                        {s.body && (
                                                            <p class="resource-step__body">
                                                                {s.body}
                                                            </p>
                                                        )}
                                                        {s.image && (
                                                            <figure class="resource-step__figure">
                                                                <Image
                                                                    src={
                                                                        s.image
                                                                    }
                                                                    alt={
                                                                        s.imageAlt ??
                                                                        ""
                                                                    }
                                                                    widths={[
                                                                        480,
                                                                        768,
                                                                        1024,
                                                                    ]}
                                                                    sizes="(max-width: 768px) 92vw, 900px"
                                                                    loading="lazy"
                                                                    decoding="async"
                                                                    class="resource-step__img"
                                                                />
                                                                {s.imageAlt && (
                                                                    <figcaption class="resource-step__caption">
                                                                        {
                                                                            s.imageAlt
                                                                        }
                                                                    </figcaption>
                                                                )}
                                                            </figure>
                                                        )}
                                                    </li>
                                                ),
                                            )}
                                        </ol>
                                    </section>
                                )
                        }
                    </div>
                </article>
            </main>
            <Footer />
        </div>
    </body>
</html>

<style>
    .resource-hero {
        margin: 1rem 0 2rem;
    }
    .resource-hero__img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 15px;
    }
    .resource-hero__caption {
        color: var(--color-text-muted);
        margin-top: 0.5rem;
        text-align: center;
    }

    .resource-steps {
        display: grid;
        gap: 2rem;
        grid-template-columns: 1fr;
        padding-left: 1.25rem;
    }
    @media (min-width: 768px) {
        .resource-steps {
            grid-template-columns: 1fr 1fr;
        }
    }
    .resource-step {
        list-style: none;
        border: var(--border-base);
        padding: 1rem;
        background: var(--color-surface);
    }
    .resource-step__figure {
        margin: 0.5rem 0 0;
    }
    .resource-step__img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 12px;
    }
    .resource-step__caption {
        color: var(--color-text-muted);
        margin-top: 0.25rem;
    }
    /* Link styles moved to global resources.css for consistent overrides */
</style>
