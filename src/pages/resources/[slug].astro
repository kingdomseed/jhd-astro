---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeadFonts from '../../components/HeadFonts.astro';
import PageHeader from '../../components/PageHeader.astro';
import { getEntryBySlug } from 'astro:content';

const { slug } = Astro.params;

if (!slug || Array.isArray(slug)) {
  throw new Error('Invalid resource slug');
}

const entry = await getEntryBySlug('resources', slug);

if (!entry) {
  throw new Error(`Resource not found for slug: ${slug}`);
}

const { Content } = await entry.render();
const resource = entry.data;

const categoryLabels = {
  'start-here': 'Start Here',
  'adventure-journals': 'Adventure Journals',
  'dice-roller': 'Dice Roller',
  'custom-tables': 'Custom Tables',
  advanced: 'Schemas & Deep Dives',
};

const sectionAnchors = {
  'start-here': '#start-here',
  'adventure-journals': '#adventure-journals',
  'dice-roller': '#dice-roller',
  'custom-tables': '#custom-tables',
  advanced: '#schemas',
};

const parentAnchor = sectionAnchors[resource.category] ?? '';
const backHref = `/resources${parentAnchor}`;
const canonicalUrl = `https://jasonholtdigital.com/resources/${entry.slug}/`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <HeadFonts />
    <title>{resource.title} â€” Mythic Resources</title>
    <meta name="description" content={resource.summary} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="stylesheet" href="/global.css" />
  <script is:inline src="https://kit.fontawesome.com/9f0db3cdf4.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <a class="skip" href="#main">Skip to main content</a>
    <div id="bg-atmo" aria-hidden="true"></div>
    <div id="site">
      <Header />

      <PageHeader
        title={resource.title}
        subtitle={categoryLabels[resource.category]}
        description={resource.summary}
        accent="Resources"
        layout="left"
        icon="fa-solid fa-book-open"
        visualElement="grid"
        colorScheme="primary"
      />

      <main id="main" class="resource-detail-main">
        <article class="container section resource-detail" aria-labelledby="resource-detail-heading">
          <div class="resource-detail__inner">
            <p class="resource-detail__back">
              <a class="resource-back-link" href={backHref}>
                <i class="fa-slab fa-regular fa-arrow-left" aria-hidden="true"></i>
                Back to resources
              </a>
            </p>
            <header class="resource-detail__header">
              <h2 id="resource-detail-heading" class="resource-detail__title">{resource.title}</h2>
              <div class="resource-detail__meta" aria-label="Resource metadata">
                <span class="resource-pill">{categoryLabels[resource.category]}</span>
                {resource.duration && <span class="resource-pill">{resource.duration}</span>}
                {resource.updated && <span class="resource-pill">Updated {resource.updated}</span>}
              </div>
              {resource.externalUrl && (
                <p class="resource-detail__download">
                  <a class="btn btn--shadow-accent" href={resource.externalUrl} target="_blank" rel="noopener">
                    <i class="fa-slab fa-regular fa-download" aria-hidden="true"></i>
                    Open schema / download
                  </a>
                </p>
              )}
            </header>
            <div class="resource-detail__content">
              <Content />
            </div>
          </div>
        </article>
      </main>
      <Footer />
    </div>
  </body>
</html>
