---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeadFonts from '../../components/HeadFonts.astro';
import PageHeader from '../../components/PageHeader.astro';
import { Image } from 'astro:assets';
import { getEntryBySlug, getCollection, type CollectionEntry } from 'astro:content';

type ResourceEntry = CollectionEntry<'resources'>;

export async function getStaticPaths() {
  const entries = await getCollection('resources');
  return entries.map((entry: ResourceEntry) => ({
    params: { slug: entry.slug },
  }));
}

const { slug } = Astro.params;

if (!slug || Array.isArray(slug)) {
  throw new Error('Invalid resource slug');
}

const entry = await getEntryBySlug('resources', slug);

if (!entry) {
  throw new Error(`Resource not found for slug: ${slug}`);
}

const { Content } = await entry.render();
const resource = entry.data;

const categoryLabels = {
  'start-here': 'Start Here',
  'adventure-journals': 'Adventure Journals',
  'dice-roller': 'Dice Roller',
  'custom-tables': 'Custom Tables',
  advanced: 'Schemas & Deep Dives',
};

const sectionAnchors = {
  'start-here': '#start-here',
  'adventure-journals': '#adventure-journals',
  'dice-roller': '#dice-roller',
  'custom-tables': '#custom-tables',
  advanced: '#schemas',
};

const parentAnchor = sectionAnchors[resource.category] ?? '';
const backHref = `/resources${parentAnchor}`;
const canonicalUrl = `https://jasonholtdigital.com/resources/${entry.slug}/`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <HeadFonts />
    <title>{resource.title} â€” Mythic Resources</title>
    <meta name="description" content={resource.summary} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="stylesheet" href="/global.css" />
  <script is:inline src="https://kit.fontawesome.com/9f0db3cdf4.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <a class="skip" href="#main">Skip to main content</a>
    <div id="bg-atmo" aria-hidden="true"></div>
    <div id="site">
      <Header />

      <PageHeader
        title={resource.title}
        subtitle={categoryLabels[resource.category]}
        description={resource.summary}
        accent="Resources"
        layout="left"
        icon="fa-solid fa-book-open"
        visualElement="grid"
        colorScheme="primary"
      />

      <main id="main" class="resource-detail-main">
        <article class="container section resource-detail" aria-labelledby="resource-detail-heading">
          <div class="resource-detail__inner">
            <p class="resource-detail__back">
              <a class="resource-back-link" href={backHref}>
                <i class="fa-slab fa-regular fa-arrow-left" aria-hidden="true"></i>
                Back to resources
              </a>
            </p>
            <header class="resource-detail__header">
              <h2 id="resource-detail-heading" class="resource-detail__title">{resource.title}</h2>
              <div class="resource-detail__meta" aria-label="Resource metadata">
                <span class="resource-pill">{categoryLabels[resource.category]}</span>
                {resource.duration && <span class="resource-pill">{resource.duration}</span>}
                {resource.updated && <span class="resource-pill">Updated {resource.updated}</span>}
              </div>
              {resource.externalUrl && (
                <p class="resource-detail__download">
                  <a class="btn btn--shadow-accent" href={resource.externalUrl} target="_blank" rel="noopener">
                    <i class="fa-slab fa-regular fa-download" aria-hidden="true"></i>
                    Open schema / download
                  </a>
                </p>
              )}
            </header>
            {resource.hero && (
              <figure class="resource-hero">
                <Image
                  src={resource.hero}
                  alt={resource.heroAlt ?? ''}
                  widths={[480, 768, 1024, 1440]}
                  sizes="(max-width: 768px) 92vw, 1100px"
                  loading="eager"
                  decoding="async"
                  fetchpriority="high"
                  class="resource-hero__img"
                />
                {resource.heroAlt && <figcaption class="resource-hero__caption">{resource.heroAlt}</figcaption>}
              </figure>
            )}
            <div class="resource-detail__content">
              <Content />
            </div>
            {Array.isArray(resource.steps) && resource.steps.length > 0 && (
              <section class="section" aria-labelledby="resource-steps-title">
                <header class="section-head" aria-hidden="true">
                  <span class="accent-line" aria-hidden="true"></span>
                  <span class="badge-text">Steps</span>
                </header>
                <h3 id="resource-steps-title" class="section-title">Step-by-step</h3>
                <ol class="resource-steps">
                  {resource.steps.map((s, i) => (
                    <li class="resource-step" data-step-index={i + 1}>
                      <h4 class="resource-step__title">{s.title}</h4>
                      {s.body && <p class="resource-step__body">{s.body}</p>}
                      {s.image && (
                        <figure class="resource-step__figure">
                          <Image
                            src={s.image}
                            alt={s.imageAlt ?? ''}
                            widths={[480, 768, 1024]}
                            sizes="(max-width: 768px) 92vw, 900px"
                            loading="lazy"
                            decoding="async"
                            class="resource-step__img"
                          />
                          {s.imageAlt && <figcaption class="resource-step__caption">{s.imageAlt}</figcaption>}
                        </figure>
                      )}
                    </li>
                  ))}
                </ol>
              </section>
            )}
          </div>
        </article>
      </main>
      <Footer />
    </div>
  </body>
</html>

<style>
  .resource-hero { margin: 1rem 0 2rem; }
  .resource-hero__img { display: block; width: 100%; height: auto; border-radius: 15px; }
  .resource-hero__caption { color: var(--color-text-muted); margin-top: .5rem; text-align: center; }

  .resource-steps { display: grid; gap: 2rem; grid-template-columns: 1fr; padding-left: 1.25rem; }
  @media (min-width: 768px) { .resource-steps { grid-template-columns: 1fr 1fr; } }
  .resource-step { list-style: none; border: var(--border-base); padding: 1rem; background: var(--color-surface); }
  .resource-step__figure { margin: 0.5rem 0 0; }
  .resource-step__img { display: block; width: 100%; height: auto; border-radius: 12px; }
  .resource-step__caption { color: var(--color-text-muted); margin-top: .25rem; }
</style>
